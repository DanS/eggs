<% title "#{@farm.name} : #{@user.member.first_name} #{@user.member.last_name}"%>


<div class="grid_12">
  <h2 id="page-heading">Welcome, <%= "#{@user.member.first_name} #{@user.member.last_name}!"%></h2>  
</div>


<div class="grid_8 ">

  <p style="color: green"><%= flash[:notice] %></p>

  <% if @finalized_orders.size >= 1
      next_order = @finalized_orders.first %>
    <p>Your upcoming order (<%= "#{next_order.delivery.pretty_date} - #{next_order.delivery.name}" %>) has been finalized with a total
    of <b><%= number_to_currency next_order.finalized_total %></b>.  Please bring a check or top up your account using
    PayPal if your current balance will not cover the total.</p>

    <div class="box">

      <h2>Upcoming Pickup Details:</h2>
      <div class="block">
        <table>
          <tr>
            <th>Date/Time:</th>
            <td><%= next_order.delivery.pretty_date %>, 5-7pm</td>
          </tr>
          <tr>
            <th>Location:</th>
            <td><%= next_order.location.address %>  <%= link_to "(map)", next_order.location.map_link, :target => "_blank"%></td>
          </tr>
          <tr>
            <th>Host:</th>
            <td><%= next_order.location.host_name %></td>
          </tr>
          <tr>
            <th>Host Email:</th>
            <td><%= mail_to next_order.location.host_email, next_order.location.host_email %></td>
          </tr>
          <tr>
            <th>Host Phone:</th>
            <td><%= next_order.location.host_phone %></td>
          </tr>
        </table>
      </div>
    </div>

  <% end %>

  <% if @open_deliveries.size == 0 %>
    <div>
      There are currently no <%= @farm.name %> deliveries open for orders.
    </div>
  <% end %>

  <% if @finalized_orders.size > 0 %>
    <div class="box_header"><h4>Finalized Orders - delivery soon!:</h4></div>
    <table class="box_table">
      <% @finalized_orders.each do |order| %>
        <tr>
          <td><%= order.delivery.date %></td>
          <td><%= order.delivery.name %></td>
          <td><%= "total:  #{number_to_currency order.finalized_total}" %></td>
          <td><%= link_to "view order", order_path(:id => order, :farm_id => @farm.id) %></td>
        </tr>
      <% end %>
    </table>
  <% end %>

  <% if @inprogress_orders.size > 0 %>  
    <h4>Orders that are currently Processing:</h4>
    <table>
      <% @inprogress_orders.each do |order| %>
        <tr>
          <td><%= order.delivery.date %></td>
          <td><%= order.delivery.name %></td>
          <td><%= order.delivery.pretty_status %></td>
          <td><%= link_to "view order", order_path(:id => order, :farm_id => @farm.id) %></td>
        </tr>
      <% end %>
    </table>
  <% end %>

  <% if @open_orders.size > 0 %>    
    <h4>Your current open orders:</h4>
    <table>
      <% @open_orders.each do |order| %>
        <tr>
          <td><%= order.delivery.date %></td>
          <td><%= order.delivery.name %></td>
          <td><%= order.delivery.pretty_status %></td>
          <td><%= link_to "view/edit order", order_path(:id => order, :farm_id => @farm.id) %></td>
        </tr>
      <% end %>
    </table>
  <% end %>

  <% if @open_deliveries.size > 0 %>  
    <h4>Deliveries currently accepting new orders:</h4>
    <table>
      <%
        @open_deliveries.each do |delivery|
      %>
      <tr>
        <td><%= delivery.date %></td>
        <td><%= link_to delivery.name, new_order_path(:delivery_id => delivery.id, :farm_id => delivery.farm.id)%></td>
        <td><%= delivery.pretty_status %></td>
        <td><%= link_to "new order", new_order_path(:delivery_id => delivery.id, :farm_id => delivery.farm.id) %></td>
      </tr>
      <% end %>
    </table>
  <% end %>


</div>

<div class="grid_4">
  <div class="box">
    <h2></h2>
    <div class="block">
      <h5>Your Account Balance:</h5>
      <h4><%= number_to_currency @subscription.current_balance %></h4>
      <ul class="menu">
        <li><%= link_to "Balance Details", transactions_path(:farm_id => @farm.id, :member_id => @user.member.id)%></li>
      </ul>
    </div>
  </div>
</div>




  

